<script type="text/javascript">
$(function() {
	$( "#f_escrito" ).datepicker( {
		numberOfMonths: 1,
		showButtonPanel: true
		});

});

{{ oArrayDesplGrupo.ComprobarSelectJs|raw }}
{{ oArrayProtDestino.ComprobarSelectJs|raw }}
{{ oArrayProtRef.ComprobarSelectJs|raw }}

fnjs_cancelar=function(event){
	// Asegurarme que es por click y no por return (posicion: 0,0)
	var x = event.x || event.clientX;
    var y = event.y || event.clientY;
    if (!x && !y) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    	return false;
    }
    event.preventDefault(); //prevent default action 	
	fnjs_update_div('#main','{{ pagina_cancel|raw }}');
}

fnjs_guardar=function(event){
	// Asegurarme que es por click y no por return (posicion: 0,0)
	var x = event.x || event.clientX;
    var y = event.y || event.clientY;
    if (!x && !y) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    	return false;
    }
    
	var err=0;
	//var destino=$('#destino').val();
	var prot_num_destino=$('#prot_num_destino').val();
	var asunto=$('#asunto').val();
	var ponente=$('#id_ponente').val();
	var entradilla=$('#entradilla').val();
	var id_expediente=$('#id_expediente').val();
	var id_escrito=$('#id_escrito').val();
	var f_escrito=$('#f_escrito').val();

	//if (!destino) { alert("{{ "Debe llenar el campo de destino"|trans }}"); err=1; }
	//if (!prot_num_destino) { alert("{{ "Debe llenar el campo de protocolo destino"|trans }}"); err=1; }
	if (!asunto) { alert("{{ "Debe llenar el campo de asunto"|trans }}"); err=1; }
	if (!ponente) { alert("{{ "Debe llenar el campo del ponente"|trans }}"); err=1; }
	if (!entradilla) { alert("{{ "Debe llenar el campo de la entradilla"|trans }}"); err=1; }
	if (!f_escrito) { alert("{{ "Debe llenar el campo de fecha del escrito"|trans }}"); err=1; }
	if (!fnjs_fecha_en_intervalo('#f_escrito')) { err=1; }
	
	if (err!=1) {
		$('#form_escrito').attr('action','{{ url_update }}');
		$('#que').val('guardar');
		$('#form_escrito').one("submit", function(event){
			event.preventDefault(); //prevent default action 	
            request=$.ajax({
                data: $(this).serialize(),
                url: $(this).attr('action'),
                type: 'post',
                dataType: 'json'
            });
            request.done( function (rta) {
                var json=rta;
                id = json.id_escrito;
                if (json.success != true) {
                    rta_txt = rta.responseText;
                    alert ('error: '+rta_txt);
                } else {
                    if (id != id_escrito) {
                        // caso de nuevo escrito
                        $.confirm({
                            title: '{{ "datos guardados"|trans }}',
                            content: '{{ "¿añadir escrito o adjuntos?"|trans }}',
                            buttons: {
                                {{ "Sí"|trans }}: function () {
                                    // ir al form expediente.
                                    pagina_mod = 'apps'
                                    fnjs_update_div('#main',json.pagina_mod);
                                },
                                {{ "No"|trans }}: function () {
                                    //$.alert('Canceled!');
                                    alert ("{{ "datos guardados"|trans }}");
                                    // Volver a la lista...
                                    fnjs_update_div('#main','{{ pagina_cancel|raw }}');
                                }
                            }
                        });
                    } else {
                        alert ("{{ "datos guardados"|trans }}");
                        // Volver a la lista...
                        fnjs_update_div('#main','{{ pagina_cancel|raw }}');
                    }
                }
            });
		});
		//$('#form_expediente').submit();
		//$('#form_expediente').off();
	} else {
        event.preventDefault();
	}
}


fnjs_cambiar_reservado=function(secretari){
	var r=$('#visibilidad').val();
	// En la clase Entradas: V_RESERVADO = 3
	if (r==3 && !secretari) {
		$('#asunto').val("");
		$('#asunto').prop("disabled",false);
		$('#detalle').val("");
		$('#detalle').prop("disabled",false);
	}
}

fnjs_focus_a=function(camp){
	$(camp).focus();
}

fnjs_mas_grupos=function(e){
	var code = (e.keyCode ? e.keyCode : e.which);
	if(e=="x") {
		var valor=1;
	} else {
		var id_campo='#'+e.currentTarget.id;
		var valor=$(id_campo).val();
		if(code!=9) {
			e.preventDefault();
			e.stopPropagation();
		}
	}
	if ( code==9 || e.type=="change" || e=="x") {
		if (valor!=0) {
			{{ oArrayDesplGrupo.ListaSelectsJs|raw }}
		}
	}
}
fnjs_quitar_grupos=function(){
	$('#span_grupos').html("");
	$('#grupos_num').val(0);
}

fnjs_mas_destinos=function(e){
	var code = (e.keyCode ? e.keyCode : e.which);
	if(e=="x") {
		var valor=1;
	} else {
		var id_campo='#'+e.currentTarget.id;
		var valor=$(id_campo).val();
		if(code!=9) {
			e.preventDefault();
			e.stopPropagation();
		}
	}
	if ( code==9 || e.type=="change" || e=="x") {
		if (valor!=0) {
			{{ oArrayProtDestino.ListaSelectsJs|raw }}
		}
	}
}
fnjs_quitar_destinos=function(){
	$('#span_dst').html("");
	$('#dst_num').val(0);
}


fnjs_mas_referencias=function(e){
	var code = (e.keyCode ? e.keyCode : e.which);
	if(e=="x") {
		var valor=1;
	} else {
		var id_campo='#'+e.currentTarget.id;
		var valor=$(id_campo).val();
		if(code!=9) {
			e.preventDefault();
			e.stopPropagation();
		}
	}
	if ( code==9 || e.type=="change" || e=="x") {
		if (valor!=0) {
			{{ oArrayProtRef.ListaSelectsJs|raw }}
		}
	}
}
fnjs_quitar_referencias=function(){
	$('#span_ref').html("");
	$('#ref_num').val(0);
}

fnjs_proto=function(e,num,any){
	var s=0;
	var numero;
	var siguiente="";
	//debugger;
	siguiente = num.replace(/_num_/g, "_mas_"); 
	num_escaped = num.replace(/[-[\]{}()*+?.,\\^$|\s]/g, "\\$&");
	any_escaped = any.replace(/[-[\]{}()*+?.,\\^$|\s]/g, "\\$&");
	siguiente_escaped = siguiente.replace(/[-[\]{}()*+?.,\\^$|\s]/g, "\\$&");
	var prot_num=$(num_escaped).val();
	var prot_any=$(any_escaped).val();
	if (prot_num === undefined) {
		return;
	}
	numero=prot_num.split("/");
	if (numero[1]) {
		$(num_escaped).val(numero[0]);
		$(any_escaped).val(numero[1]);
		prot_any=$(any).val();
  	} else {
		if (!prot_any) {
			var calDate = new Date();
  			var year  = calDate.getFullYear();
			$(any).val(year);
			prot_any=year;
		}
	}

	$(siguiente_escaped).focus(); 
	
	/* Para el número de origen */
	if (num=='#origen_prot_num') {
		que="e2";
		id_lugar=$('#origen').val();
		var nom_lugar=$('#origen option:selected').text();
		if (nom_lugar=='cr') {
			$('#grupo_destinos').show();
		}
		prot_num=$('#origen_prot_num').val();
		prot_any=$('#origen_prot_any').val();
		siguiente="#mas_ref_id_lugar";
		var primera_ref=0;
	}
	/* Para el número de referencia */
	if (num.substr(0,13)=='#ref_prot_num') {
		/* sólo recojo información de la primera referencia */
		if (num.substr(14,1)=='0') {
			que="e3";
			var nom='#ref_id_lugar_0';
			id_lugar=$(nom).val();
			prot_num=$(num).val();
			prot_any=$(any).val();
			siguiente="#f_doc_entrada";
		} else {
			$('#f_doc_entrada').focus();
			return; /* no hago nada */
		}
	}

	//var url='apps/core/comprobar_protocolo.php';
	//var parametros='que='+que+'&id_lugar='+id_lugar+'&prot_num='+prot_num+'&prot_any='+prot_any+'&PHPSESSID=<?php echo session_id(); ?>';
		 
	{#
	$.ajax({
		url: url,
		type: 'post',
		data: parametros,
		success: function (rta) {
			//alert ('respuesta: '+rta);
			rta2=jQuery.parseJSON(rta);
			if (rta2.rango) { alert("{{ "nº de protocolo fuera de rango"|trans }}"); s=1; }
			if (rta2.any) { alert("{{ "No es de este año, ni del año pasado"|trans }}"); s=1; }
			if (rta2.repe) { alert("{{ "nº de protocolo repetido"|trans }}");  s=1; }
			if (rta2.registrado) { alert("{{ "nº de protocolo de origen ya registrado"|trans }}");  s=1; }
			if (rta2.anulado) {
				alert("{{"El escrito de referencia ha sido anulado"|trans }}"+" ("+rta2.anulado+").");
			}
			if (rta2.salto) {
				alert("{{ "El nº de protocolo tiene un salto de más de %s números respecto al último"|trans|format(error_prot) }}"+" ("+rta2.salto+").");
				s=1;
			}
			if (que=="e3") {
				if (rta2.asunto) {
					//caso de escrito reservado
					if (rta2.asunto_r) {
						$('#asunto').val(rta2.asunto_r);
						$('#asunto').prop("disabled",true);
						$('#asunto_org').val(rta2.asunto);
					} else {
						$('#asunto').val(rta2.asunto);
					}
				} 
				if (rta2.detalle) {
					//caso de escrito reservado
					if (rta2.detalle_r) {
						$('#detalle').val(rta2.detalle_r);
						$('#detalle').prop("disabled",true);
						$('#detalle_org').val(rta2.detalle);
					} else {
						$('#detalle').val(rta2.detalle);
					}
				} 
				if (rta2.reservado=="t") {
					$('#reservado').prop("checked",true);
				} else { 
					$('#reservado').prop("checked",false);
				}
				if (rta2.oficinas) {
					//pongo a 0 (por si ya habia algo)
					fnjs_quitar_oficinas();
					var array_of=rta2.oficinas.split(" ");
					$.each(array_of,function(i,id_of) {
						if (id_of) { //puede haber un espacio al final i lo cuenta.
							$('#mas_of').val(id_of);
							fnjs_mas_oficinas('x');
						}
					});
				}
			}
			if (s==1) { $(num).focus(); } else { $(siguiente).focus(); }
		}
	});
	#}
	
    e.preventDefault();
	e.stopPropagation();
	e.stopImmediatePropagation();
	return false;
}


</script>