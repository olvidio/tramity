<script type="text/javascript">
$(function() {
	$( "#f_reunion" ).datepicker( {
		numberOfMonths: 1,
		showButtonPanel: true
		});

});
$(function() {
	$( "#f_aprobacion" ).datepicker( {
		numberOfMonths: 1,
		showButtonPanel: true
		});

});
$(function() {
	$( "#f_contestar" ).datepicker( {
		numberOfMonths: 1,
		showButtonPanel: true
		});

});
$(function() {
	$( "#f_ini_circulacion" ).datepicker( {
		numberOfMonths: 1,
		showButtonPanel: true
		});

});

{{ oArrayDesplOficinas.ComprobarSelectJs|raw }}
{{ oArrayDesplFirmasOficina.ComprobarSelectJs|raw }}
{{ oArrayDesplFirmas.ComprobarSelectJs|raw }}
{{ oArrayProtRef.ComprobarSelectJs|raw }}

fnjs_cancelar=function(event){
	// Asegurarme que es por click y no por return (posicion: 0,0)
	var x = event.x || event.clientX;
    var y = event.y || event.clientY;
    if (!x && !y) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    	return false;
    }
    event.preventDefault(); //prevent default action 	
	fnjs_update_div('#main','{{ pagina_cancel|raw }}');
}


fnjs_comprobar_plazo=function(){
	contestar=$('#prioridad').val();
    var hoy=new Date();
    var fecha=new Date();
    switch (contestar) {
        case "{{ prioridad_fecha }}":
            // activo el campo input y pongo allí el cursor
            $("#f_contestar").prop("disabled", false);
            $('#f_contestar').focus();
            $('#f_contestar').val('');
            break;
        case "{{ prioridad_desconocido }}":
            $('#f_contestar').val('');
            $('#f_contestar').prop("disabled",false);
            break;
        case "{{ prioridad_rapido }}":
            var dias={{ plazo_rapido }};
            var mseconds=hoy.getTime()+dias*24*60*60*1000;
            fecha.setTime(mseconds);
            var mes=fecha.getMonth()+1;
            $('#f_contestar').val(fecha.getDate()+"/"+mes+"/"+fecha.getFullYear());
           // $('#f_contestar').prop("disabled",true);
            break;
        case "{{ prioridad_urgente }}":
            var dias={{ plazo_urgente }};
            var mseconds=hoy.getTime()+dias*24*60*60*1000;
            fecha.setTime(mseconds);
            var mes=fecha.getMonth()+1;
            $('#f_contestar').val(fecha.getDate()+"/"+mes+"/"+fecha.getFullYear());
            //$('#f_contestar').prop("disabled",true);
            break;
        case "{{ prioridad_normal }}":
            var dias={{ plazo_normal }};
            var mseconds=hoy.getTime()+dias*24*60*60*1000;
            fecha.setTime(mseconds);
            var mes=fecha.getMonth()+1;
            $('#f_contestar').val(fecha.getDate()+"/"+mes+"/"+fecha.getFullYear());
            //$('#f_contestar').prop("disabled",true);
            break;
    }
    $('#b_guardar').focus();
}

/**
 * segun el tramite mira si hay que mostrar 
 * 	- firmas de la oficina
 *	- firmas para otras oficinas
 */
fnjs_tramite=function(){
	var tramite=$('#tramite').val();
    var url = '{{ url_ajax }}';
    var param_json = { que: 'info_firmas', id_tramite: tramite };
    request=$.ajax({
        data: param_json,
        url: url,
        type: 'post'
    });
    request.done( function (json) {
        if (json.success != true) {
            rta_txt = json.responseText;
            alert ('error: '+rta_txt);
        } else {
	        data = jQuery.parseJSON(json.data);
	        if (data.varias) {
				$('#div_firmas').show();
		    } else {
                $('#div_firmas').hide();
		    }
	        if (data.oficiales) {
                $('#div_firmas_oficina').show();
		    } else {
                $('#div_firmas_oficina').hide();
			}
        }
    });
}


fnjs_visto=function(event){
	// Asegurarme que es por click y no por return (posicion: 0,0)
	var x = event.x || event.clientX;
    var y = event.y || event.clientY;
    if (!x && !y) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    	return false;
    }
    $('#form_expediente').attr('action','{{ url_update }}');
    $('#que').val('visto');
    $('#form_expediente').submit(function(event){
        event.preventDefault(); //prevent default action 	
        request=$.ajax({
            data: $(this).serialize(),
            url: $(this).attr('action'),
            type: 'post',
            dataType: 'json'
        });
        request.done( function (json) {
            id = json.id_expediente;
            if (json.success != true) {
                rta_txt = json.responseText;
                alert ('error: '+rta_txt);
            } else {
	            html = json.html;
                // Volver a la lista...
                $('#div_preparar').html(html);
            }
        });
    });
}

fnjs_circular=function(event){
	/* TODO
	* primero habría que guardar
	*/
	
	// Asegurarme que es por click y no por return (posicion: 0,0)
	var x = event.x || event.clientX;
    var y = event.y || event.clientY;
    if (!x && !y) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    	return false;
    }

    // comprobar que tiene gente para firmar
    var err=0;
	var firma='';
	var i=0;
	var selector="span#span_firmas select";
	$(selector).each(function(i) {
		if ($(this).val().length) {  
			i++;
			if (i>1) firma+=",";
			firma+=$(this).val();
		}
	});

	if (!firma) { alert("{{ "Debe llenar el campo de oficinas"|trans }}"); err=1; }
	
	if (err!=1) {
        $('#form_expediente').attr('action','{{ url_update }}');
        $('#que').val('circular');
        $('#form_expediente').submit(function(event){
            event.preventDefault(); //prevent default action 	
            request=$.ajax({
                data: $(this).serialize(),
                url: $(this).attr('action'),
                type: 'post',
                dataType: 'json'
            });
            request.done( function (json) {
                if (json.success != true) {
                    rta_txt = json.error_txt;
                    alert ('error: '+rta_txt);
                } else {
                    alert ("{{ "circulando!"|trans }}");
                    // Volver a la lista...
                    fnjs_update_div('#main','{{ pagina_cancel|raw }}');
                }
            });
        });
	} else {
        event.preventDefault();
	}
}

fnjs_guardar=function(event){
	// Asegurarme que es por click y no por return (posicion: 0,0)
	var x = event.x || event.clientX;
    var y = event.y || event.clientY;
    if (!x && !y) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    	return false;
    }

	var err=0;
	var id_expediente=$('#id_expediente').val();
	var tramite=$('#tramite').val();
	var estado=$('#estado').val();
	var prioridad=$('#prioridad').val();
	var asunto=$('#asunto').val();

	var firma='';
	var i=0;
	var selector="span#span_firmas select";
	$(selector).each(function(i) {
		if ($(this).val().length) {  
			i++;
			if (i>1) firma+=",";
			firma+=$(this).val();
		}
	});

	if (!tramite) { alert("{{ "Debe llenar el campo de tramite"|trans }}"); err=1; }
	//if (!estado) { alert("{{ "Debe llenar el campo de estad"|trans }}"); err=1; }
	if (!prioridad) { alert("{{ "Debe llenar el campo de prioridad"|trans }}"); err=1; }
	if (!asunto) { alert("{{ "Debe llenar el campo de asunto expediente"|trans }}"); err=1; }
	
	if (err!=1) {
		$('#firmas').val(firma);
		$('#form_expediente').attr('action','{{ url_update }}');
		$('#que').val('guardar');
		$('#form_expediente').submit(function(event){
			event.preventDefault(); //prevent default action 	
            request=$.ajax({
                data: $(this).serialize(),
                url: $(this).attr('action'),
                type: 'post',
                dataType: 'json'
            });
            request.done( function (json) {
                if (json.success != true) {
                    rta_txt = json.error_txt;
                    alert ('error: '+rta_txt);
                } else {
                    id = json.id_expediente;
                    if (id != id_expediente) {
                        // caso de nuevo expediente
                        $.confirm({
                            title: '{{ "datos guardados"|trans }}',
                            content: '{{ "¿añadir escrito o adjuntos?"|trans }}',
                            buttons: {
                                {{ "Sí"|trans }}: function () {
                                    // ir al form expediente.
                                    pagina_mod = 'apps'
                                    fnjs_update_div('#main',json.pagina_mod);
                                },
                                {{ "cancelar"|trans }}: function () {
			                        fnjs_update_div('#main','{{ pagina_cancel|raw }}');
                                    //$.alert('Canceled!');
                                },
                                somethingElse: {
                                    text: '{{ "otro expediente"|trans }}',
                                    btnClass: 'btn-blue',
                                    keys: ['enter', 'shift'],
                                    // Nueva expediente.
                                    action: fnjs_update_div('#main','{{ pagina_nueva|raw }}')
                                }
                            }
                        });
                    } else {
                        alert ("{{ "datos guardados"|trans }}");
                        // Volver a la lista...
                        fnjs_update_div('#main','{{ pagina_cancel|raw }}');
                    }
                }
            });
		});
		//$('#form_expediente').submit();
		//$('#form_expediente').off();
	} else {
        event.preventDefault();
	}
}


fnjs_mas_firmas=function(e){
	var code = (e.keyCode ? e.keyCode : e.which);
	if(e=="x") {
		var valor=1;
	} else {
		var id_campo='#'+e.currentTarget.id;
		var valor=$(id_campo).val();
		if(code!=9) {
			e.preventDefault();
			e.stopPropagation();
		}
	}
	if ( code==9 || e.type=="change" || e=="x") {
		if (valor!=0) {
			{{ oArrayDesplFirmas.ListaSelectsJs|raw }}
		}
	}
}

fnjs_quitar_firmas=function(){
	$('#span_firmas').html("");
	$('#firmas_num').val(0);
}
fnjs_mas_firmas_oficina=function(e){
	var code = (e.keyCode ? e.keyCode : e.which);
	if(e=="x") {
		var valor=1;
	} else {
		var id_campo='#'+e.currentTarget.id;
		var valor=$(id_campo).val();
		if(code!=9) {
			e.preventDefault();
			e.stopPropagation();
		}
	}
	if ( code==9 || e.type=="change" || e=="x") {
		if (valor!=0) {
			{{ oArrayDesplFirmasOficina.ListaSelectsJs|raw }}
		}
	}
}

fnjs_quitar_firmas_oficina=function(){
	$('#span_firmas_oficina').html("");
	$('#firmas_oficina_num').val(0);
}
</script>
